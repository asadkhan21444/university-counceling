{% extends 'My_Admin/base1.html' %}
{% block title %}Counsellor Reviews{% endblock %}
{% block page_title %}All Reviews{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <a href="{% url 'review_add' %}" class="btn btn-primary mb-3">+ Add New Review</a>

    <table class="table table-bordered table-striped">
        <thead class="table-dark">
            <tr>
                <th>#</th>
                <th>Counsellor</th>
                <th>Student</th>
                <th>Rating</th>
                <th>Review Text</th>
                <th>Created</th>
                <th>Approved?</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
        {% for review in reviews %}
            <tr>
                <td>{{ forloop.counter }}</td>
                <td>{{ review.counsellor.user.get_full_name }}</td>
                <td>{{ review.student.user.get_full_name }}</td>
                <td>{{ review.rating }}</td>
                <td>{{ review.review_text|truncatechars:50 }}</td>
                <td>{{ review.created_at|date:"Y-m-d H:i" }}</td>
                <td>
                    {% if review.is_approved %}
                        <span class="badge bg-success">Yes</span>
                    {% else %}
                        <span class="badge bg-warning">No</span>
                    {% endif %}
                </td>
                <td>
                    <a href="{% url 'review_update' review.pk %}" class="btn btn-sm btn-warning">Edit</a>
                    <button class="btn btn-sm btn-danger delete-btn" data-id="{{ review.pk }}">Delete</button>
                </td>
            </tr>
        {% empty %}
            <tr><td colspan="8" class="text-center">No reviews yet.</td></tr>
        {% endfor %}
        </tbody>
    </table>
</div>

<!-- SweetAlert -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.querySelectorAll(".delete-btn").forEach(btn => {
    btn.addEventListener("click", function() {
        let reviewId = this.getAttribute("data-id");
        Swal.fire({
            title: "Are you sure?",
            text: "This record will be permanently deleted.",
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "Yes, delete it!"
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/reviews/delete/${reviewId}/`, {
                    method: "POST",
                    headers: { "X-CSRFToken": "{{ csrf_token }}" }
                })
                .then(res => res.json())
                .then(data => {
                    if(data.success){
                        Swal.fire("Deleted!", data.message, "success")
                            .then(() => location.reload());
                    } else {
                        Swal.fire("Error!", data.message, "error");
                    }
                });
            }
        });
    });
});
</script>

{% if messages %}
<script>
{% for message in messages %}
Swal.fire({
    icon: "{{ message.tags }}",
    title: "{{ message }}",
    timer: 2000,
    showConfirmButton: false
});
{% endfor %}
</script>
{% endif %}

{% endblock %}
